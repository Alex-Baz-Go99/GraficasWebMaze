<html>
<head>
	<title>2.3 Colisiones</title>
	<script type="text/javascript" src="js/libs/jquery/jquery-2.1.4.min.js"></script>
	<script type="text/javascript" src="js/libs/three/three.js"></script>
	<script type="text/javascript" src="js/libs/three/MTLLoader.js"></script>
	<script type="text/javascript" src="js/libs/three/OBJLoader.js"></script>
	<script type="text/javascript">

	var scene;
	var camera;
	var renderer;
	var controls;
	
	var mainModeWalls = [
		[0,0], [0,1], [0,2], [0,3], [0,4], [0,5], [0,6], [0,7], [0,8], [0,9], [0,10], [0,11], [0,12], [0,13], [0,14], [0,15], [0,16], [0,17], [0,18], [0,19],
		[1,6], [1,19],
		[2,0], [2,2], [2,3], [2,4], [2,6], [2,8], [2,10], [2,11], [2,12], [2,19],
		[3,0], [3,8], [3,11], [3,14], [3,15], [3,16], [3,17], [3,19],
		[4,0], [4,2], [4,4], [4,5], [4,6], [4,8], [4,9], [4,11], [4,13], [4,14], [4,19],
		[5,0], [5,8], [0,9], [5,16], [5,17], [5,19],
		[6,0], [6,1], [6,2], [6,3], [6,4], [6,5], [6,6], [6,8], [6,10], [6,11], [6,12], [6,14], [6,19],
		[7,0], [7,17], [7,19],
		[8,0], [8,2], [8,4], [8,5], [8,6], [8,7], [8,9], [8,10], [8,11], [8,13], [8,15], [8,19],
		[9,0], [9,2], [9,13], [9,17], [9,19],
		[10,0], [10,2], [10,3], [10,4], [10,5], [10,6], [10,7], [10,9], [0,10], [10,11], [10,12], [10,13], [10,14], [10,19],
		[11,0], [11,11], [11,16], [11,17], [11,19],
		[12,0], [12,2], [12,3], [12,5], [12,7], [12,8], [12,10], [12,11], [12,13], [12,14],[12,16], [12,19],
		[13,0], [13,2], [13,5], [13,7], [13,8], [13,13], [13,14], [13,16], [13,18], [13,19],
		[14,0], [14,4], [14,5], [14,10], [14,11], [14,19],
		[15,0], [15,2], [15,4], [15,5], [15,7], [15,8], [15,10], [15,11], [15,13], [15,14],  [15,16], [15,17], [15,19],
		[16,0], [0,19],
		[17,0], [17,1], [17,2], [17,3], [17,4], [17,5], [17,6], [17,7], [17,8], [17,9], [17,10], [17,11], [17,12], [17,13], [17,14], [17,16], [17,17], [17,18], [17,19],
		[18,0], [18,1], [18,2], [18,3], [18,4], [18,5], [18,6], [18,7], [18,8], [18,9], [18,10], [18,11], [18,12], [18,13], [18,14], [18,16], [18,17], [18,18], [18,19],
		[19,0], [19,1], [19,2], [19,3], [19,4], [19,5], [19,6], [19,7], [19,8], [19,9], [19,10], [19,11], [19,12], [19,13], [190,14], [19,15], [19,16], [19,17], [19,18], [19,19],


	];


	var objects = {
		boxes:"boxes",
		fakeBoxes:"fakeBoxes",
		decorators:"decorators",
		spikes:"spikes",
		crushWalls:"crushWalls",
		mannequins:"mannequins",
	};

	objects.boxes = [];
	objects.fakeBoxes = [{x:"coordX", y:"posy", z:"coordZ"}];
	objects.decorators = [{x:"coordX", y:"posy", z:"coordZ"}];
	objects.spikes = [{x:"coordX", y:"posy", z:"coordZ"}];
	objects.crushWalls = [{x:"coordX", y:"posy", z:"coordZ"}];
	objects.mannequins = [{x:"coordX", y:"posy", z:"coordZ"}];

	var clock;
	var deltaTime;	
	var keys = {};
	var moto;

	// Clase que nos permite "lanzar" un rayo hacia diferentes direcciones
	// y detectar si el "rayo" colisiona con un objeto en esa direccion
	var rayCaster;
	var collisionObjects = []; 
	var isWorldReady = [ false, false ];
	$(document).ready(function() {

		setupScene();
		rayCaster = new THREE.Raycaster();

		function positionObject(object) {
				if(object == "box"){

					var geometria = new THREE.BoxGeometry(10, 10, 10);
					var material = new THREE.MeshLambertMaterial( { color: new THREE.Color(0, 0.6, 0.7), wireframe:false } );
					
					cubo = new THREE.Mesh(geometria, material);

					cubo.position.z = -40;
					cubo.position.x = -44;
					cubo.position.y = 5;

					mainModeWalls.forEach(function(element){
						var asset = cubo.clone();
						 
						asset.coordZ = element[0];
						asset.coordX = element[1];
						asset.position.x +=  asset.coordX*10;
						asset.position.z +=  asset.coordZ*10;
						objects.boxes.push(asset);
					});

					objects.boxes.forEach(function(box){
						collisionObjects.push(box);
					});
				}
		}

		loadOBJWithMTL("assets/", "laPared.obj", "laParedFuturo.mtl", (object) => {
			/*//Primera pared-----------------------------------------------------------------------------
			object.position.z = -43;
			object.position.x = 34;
			object.position.y = -2;
			//object.scale.set(1.92,2,1);
			object.scale.set(1.92, 2,1);

			var box2 = object.clone();
			box2.position.x = -0.4;
		
			var box3 = object.clone();
			box3.position.x = -33;
			//--------------------------------------------------------------------------------------------
			//Segunda pared-----------------------------------------------------------------------------
			var box4 = object.clone();
			box4.position.x = 30;
			box4.position.z = 33;

			var box5 = box4.clone();
			box5.position.x = 6;
			box5.scale.set(0.8,2,1);

			var box6 = box4.clone();
			box6.position.x = -33;

			//--------------------------------------------------------------------------------------------
			//Tercera pared-----------------------------------------------------------------------------
			var box7 = object.clone();		
			box7.position.z = -18;
			box7.position.x = 43.5;
			box7.rotation.y = THREE.Math.degToRad(90);

			var box8 = object.clone();		
			box8.position.z = 14;
			box8.position.x = 43.5;
			box8.rotation.y = THREE.Math.degToRad(90);
			//--------------------------------------------------------------------------------------------
			//Cuarta pared-----------------------------------------------------------------------------
			var box9 = object.clone();		
			box9.position.x = -42.4;
			box9.position.z = 23;
			box9.rotation.y = THREE.Math.degToRad(-90);

			var box10 = object.clone();		
			box10.position.x = -42.4;
			box10.position.z = -6;
			box10.rotation.y = THREE.Math.degToRad(-90);
			//--------------------------------------------------------------------------------------------
			//Paredes horizontales largas-----------------------------------------------------------------------------
			var box11 = object.clone();
			box11.position.x = -37;
			box11.position.z = -12;
			box11.scale.set(1.34,2,1);

			var box12 = box11.clone();
			box12.position.x = -15;
			box12.position.z = 0;

			var box13 = box11.clone();
			box13.position.x = -15;
			box13.position.z = 8;

			var box14 = box11.clone();
			box14.position.x = -3;
			box14.position.z = -12;

			var box15 = box11.clone();
			box15.position.x = -3;
			box15.position.z = -28;

			var box16 = box11.clone();
			box16.position.x = 30;
			box16.position.z = -28;

			var box17 = box11.clone();
			box17.position.x = 30;
			box17.position.z = 25;
			//--------------------------------------------------------------------------------------------
			//Paredes horizontales Cortas-----------------------------------------------------------------------------
			var shortWallHor1 = object.clone();
			shortWallHor1.position.x = 44;
			shortWallHor1.position.z = 14;
			shortWallHor1.scale.set(0.5,2,1);

			var shortWallHor2 = shortWallHor1.clone(); //Esta requiere una pared vertical
			shortWallHor2.position.x = 4;
			shortWallHor2.position.z = 25;

			var shortWallHor3 = shortWallHor1.clone();
			shortWallHor3.position.x = -14;
			shortWallHor3.position.z = 25;

			var shortWallHor4 = shortWallHor1.clone();
			shortWallHor4.position.x = -7;
			shortWallHor4.position.z = 16;

			var shortWallHor5 = shortWallHor1.clone(); //Esta requiere una pared vertical
			shortWallHor5.position.x = 6;
			shortWallHor5.position.z = 12;

			var shortWallHor6 = shortWallHor1.clone(); //Esta requiere una pared vertical
			shortWallHor6.position.x = 34;
			shortWallHor6.position.z = -2;

			var shortWallHor7 = shortWallHor1.clone(); 
			shortWallHor7.position.x = 6;
			shortWallHor7.position.z = -5;

			var shortWallHor8 = shortWallHor1.clone(); //Esta requiere una pared vertical
			shortWallHor8.position.x = 26;
			shortWallHor8.position.z = 12;

			var shortWallHor9 = shortWallHor1.clone(); //Esta requiere una pared vertical
			shortWallHor9.position.x = -32;
			shortWallHor9.position.z = -25;

			var shortWallHor10 = shortWallHor1.clone(); //Esta requiere una pared vertical
			shortWallHor10.position.x = 14;
			shortWallHor10.position.z = -18;

			var shortWallHor11 = shortWallHor1.clone(); 
			shortWallHor11.position.x = 35;
			shortWallHor11.position.z = -18;

			var shortWallHor12 = shortWallHor1.clone(); //Esta requiere una pared vertical
			shortWallHor12.position.x = -36;
			shortWallHor12.position.z = 15;

			var shortWallHor13 = shortWallHor1.clone(); //Esta requiere una pared vertical
			shortWallHor13.position.x = -36;
			shortWallHor13.position.z = -5;4

			var shortWallHor14 =box5.clone();
			shortWallHor14.position.x = 34;
			shortWallHor14.position.z = -12;
			shortWallHor14.scale.set(0.55,2,1);
			//--------------------------------------------------------------------------------------------
			//Paredes verticales Cortas-------------------------------------------------------------------
			var shortWallVer1 = shortWallHor1.clone();		
			shortWallVer1.position.x = -32.5;
			shortWallVer1.position.z = 11.7;
			shortWallVer1.rotation.y = THREE.Math.degToRad(-90);
			shortWallVer1.scale.set(1.05,2,1);
			shortWallVer1.scale.set(1.05,2,1);
			
			var shortWallVer2 = shortWallVer1.clone();		
			shortWallVer2.position.x = -18;
			shortWallVer2.position.z = 25;
			shortWallVer2.scale.set(0.5,2,1);

			var shortWallVer3 = shortWallVer2.clone();		
			shortWallVer3.position.x = 16;
			shortWallVer3.position.z = 28.5;

			var shortWallVer4 = shortWallVer1.clone();		
			shortWallVer4.position.x = 18;
			shortWallVer4.position.z = 14;
			shortWallVer4.scale.set(0.65,2,1);

			var shortWallVer5 = shortWallVer1.clone();		
			shortWallVer5.position.x = 30;
			shortWallVer5.position.z = 4;

			var shortWallVer6 = shortWallVer1.clone();		
			shortWallVer6.position.x = -14;
			shortWallVer6.position.z = -17.5;

			var shortWallVer7 = shortWallVer2.clone();		
			shortWallVer7.position.x = 22;
			shortWallVer7.position.z = -30;

			var shortWallVer8 = shortWallVer2.clone();		
			shortWallVer8.position.x = 5;
			shortWallVer8.position.z = 45;

			var shortWallVer9 = shortWallVer2.clone();		
			shortWallVer9.position.x = -8;
			shortWallVer9.position.z = 45;
			
			//--------------------------------------------------------------------------------------------
			//Paredes Troll-------------------------------------------------------------------
			var boxTroll1 = box5.clone();
			boxTroll1.position.x = -8.5;

			var boxTroll3 = boxTroll1.clone();
			boxTroll3.position.x = -8.5;
			boxTroll3.position.z = 43;

			var boxTroll2 =shortWallVer6.clone();
			boxTroll2.position.x = 4;
			boxTroll2.position.z = 11;
			boxTroll2.scale.set(0.55,2,1);
			//--------------------------------------------------------------------------------------------

			//--------------------------------------------------------------------------------------------
			// scene.add(object);
			// scene.add(box2);
			// scene.add(box3);
			// scene.add(box4);
			// scene.add(box5);
			// scene.add(box6);
			// scene.add(box7);
			// scene.add(box8);
			// scene.add(box9);
			// scene.add(box10);
			// scene.add(box11);
			// scene.add(box12);
			// scene.add(box13);
			// scene.add(box14);
			// scene.add(box15);
			// scene.add(box16);
			// scene.add(box17);

			// scene.add(shortWallHor1);
			// scene.add(shortWallHor2);
			// scene.add(shortWallHor3);
			// scene.add(shortWallHor4);
			// scene.add(shortWallHor5);
			// scene.add(shortWallHor6);
			// scene.add(shortWallHor7);
			// scene.add(shortWallHor8);
			// scene.add(shortWallHor9);
			// scene.add(shortWallHor10);
			// scene.add(shortWallHor11);
			// scene.add(shortWallHor12);
			// scene.add(shortWallHor13);
			

			// scene.add(shortWallVer1);
			// scene.add(shortWallVer2);
			// scene.add(shortWallVer3);
			// scene.add(shortWallVer4);
			// scene.add(shortWallVer5);
			// scene.add(shortWallVer6);
			// scene.add(shortWallVer7);
			// scene.add(shortWallVer8);
			// scene.add(shortWallVer9);

			// scene.add(boxTroll1);
			// scene.add(boxTroll2);
			// scene.add(boxTroll3);

			collisionObjects.push(object);
			collisionObjects.push(box2);
			collisionObjects.push(box3);
			collisionObjects.push(box4);
			collisionObjects.push(box5);
			collisionObjects.push(box6);
			collisionObjects.push(box7);
			collisionObjects.push(box8);
			collisionObjects.push(box9);
			collisionObjects.push(box10);
			collisionObjects.push(box11);
			collisionObjects.push(box12);
			collisionObjects.push(box13);
			collisionObjects.push(box14);
			collisionObjects.push(box15);
			collisionObjects.push(box16);
			collisionObjects.push(box17);

			collisionObjects.push(shortWallHor1);
			collisionObjects.push(shortWallHor2);
			collisionObjects.push(shortWallHor3);
			collisionObjects.push(shortWallHor4);
			collisionObjects.push(shortWallHor5);
			collisionObjects.push(shortWallHor6);
			collisionObjects.push(shortWallHor7);
			collisionObjects.push(shortWallHor8);
			collisionObjects.push(shortWallHor9);
			collisionObjects.push(shortWallHor10);
			collisionObjects.push(shortWallHor11);
			collisionObjects.push(shortWallHor12);
			collisionObjects.push(shortWallHor13);

			collisionObjects.push(shortWallVer1);
			collisionObjects.push(shortWallVer2);
			collisionObjects.push(shortWallVer3);
			collisionObjects.push(shortWallVer4);
			collisionObjects.push(shortWallVer5);
			collisionObjects.push(shortWallVer6);
			collisionObjects.push(shortWallVer7);
			collisionObjects.push(boxTroll3);

			collisionObjects.forEach(function(pared){
				scene.add(pared);
			})

			isWorldReady[0] = true;*/
		});

		loadOBJWithMTL("assets/", "jetski.obj", "jetski.mtl", (object) => {
			object.position.z = -26;
			object.rotation.x = THREE.Math.degToRad(-90);
			object.rotation.z = THREE.Math.degToRad(90);

			object.name = "moto";

			scene.add(object);
			collisionObjects.push(object);//colision con la moto
			isWorldReady[1] = true;
		});

		loadOBJWithMTL("assets/", "plataforma.obj", "plataforma.mtl", (object) => {
			object.position.z = 1;
			object.position.y = -1;
			object.scale.set(2.3,1,2.13);

			scene.add(object);
			collisionObjects.push(object);//colision con la moto
			isWorldReady[2] = true;
		});

		(function() {
						
			/*var geometria = new THREE.BoxGeometry(10, 10, 10);
			var material = new THREE.MeshLambertMaterial( { color: new THREE.Color(0.7, 0, 0), wireframe:true } );
			
			cubo = new THREE.Mesh(geometria, material);
			cubo2 = cubo.clone();
			
			cubo.position.z = -40;
			cubo.position.x = 56;
			cubo.position.y = 5;
			
			collisionObjects.push(cubo);

			cubo2.position.z = cubo.position.z + 90;
			cubo2.position.x = cubo.position.x - 90;

			collisionObjects.push(cubo2);

			for (let i = 0; i < 10; i++){
				var cuboT1 = cubo.clone();
				var cuboT2 = cubo.clone();
				var cuboT3 = cubo2.clone();
				var cuboT4 = cubo2.clone();
				
				//PARED SUPERIOR-----------------------------------------------------------------------------
				cuboT1.position.x = cubo.position.x - i*10;
				collisionObjects.push(cuboT1);

				//PARED DERECHA-----------------------------------------------------------------------------
				cuboT2.position.x = 56;
				cuboT2.position.z = cubo.position.z + i*10;
				collisionObjects.push(cuboT2);

				//PARED IZQUIERDA-----------------------------------------------------------------------------
				if(i < 8){
					cuboT3.position.z = cubo2.position.z - i*10;
					collisionObjects.push(cuboT3);
				}

				//PARED INFERIOR-----------------------------------------------------------------------------
				if(i < 9){
					cuboT4.position.x = cubo2.position.x + i*10;
					collisionObjects.push(cuboT4);
				}
			}*/

			positionObject("box");

			collisionObjects.forEach(function(block){
				scene.add(block);
			})

			isWorldReady[0] = true;
			//scene.add(cubo);
		}());
		
		render();

		document.addEventListener('keydown', onKeyDown);
		document.addEventListener('keyup', onKeyUp);		
	});

	function loadOBJWithMTL(path, objFile, mtlFile, onLoadCallback) {
		var mtlLoader = new THREE.MTLLoader();
		mtlLoader.setPath(path);
		mtlLoader.load(mtlFile, (materials) => {
			
			var objLoader = new THREE.OBJLoader();
			objLoader.setMaterials(materials);
			objLoader.setPath(path);
			objLoader.load(objFile, (object) => {
				onLoadCallback(object);
			});

		});
	}

	function onKeyDown(event) {
		keys[String.fromCharCode(event.keyCode)] = true;
	}

	function onKeyUp(event) {
		keys[String.fromCharCode(event.keyCode)] = false;
	}

	function render() {
		requestAnimationFrame(render);
		deltaTime = clock.getDelta();	
		moto = scene.getObjectByName("moto");
		var yaw = 0;
		var forward = 0;
		if (keys["A"]) {
			yaw = 5;
		} else if (keys["D"]) {
			yaw = -5;
		}
		if (keys["W"]) {
			forward = -20;
		} else if (keys["S"]) {
			forward = 20;
		}

		var player1 = scene.getObjectByName("moto");

		camera.position.x = player1.position.x;
		camera.position.x = player1.position.z;

		if (isWorldReady[0] && isWorldReady[1]) {
			moto.rotation.z += yaw * deltaTime;
			moto.translateX(forward * deltaTime);
			
			// Collision
			// Recorremos los "rayos" a lanzar para detectar las colisiones
			for (var i = 0; i < camera.rays.length; i++) {
				// Lanzamos el rayo
				// El primero parametro es para saber desde donde vamos a lanzar el rayo (desde la camara)
				// El segundo parametro es para saber la direccion a la cual lanzaremos el rayo
				rayCaster.set(moto.position, camera.rays[i]);
				// Verificamos si hay colision con algun objeto.
				// El primer parametro es el objeto o la coleccion de objetos 
				// los cuales vamos a tomar en cuenta para colisionar
				// El segundo parametro es para indicar que aparte de verificar
				// si existe colision con estos objetos tambien verifique colision con los hijos de estos objetos
				var collision = rayCaster.intersectObjects(collisionObjects, true);	
				if(collision.length){
					console.log(collision[0].distance);
				}
				else{
					console.log("nada");
				}
				// En el if podemos ver que tambien tenemos control para saber a que distancia esta colisionando
				if (collision.length > 0 && collision[0].distance < 1) {
					console.log("colisionando");
					//Profe, esta fue la solución que encontré después de 4 horas, solo son 2 líneas de código evita que atravieses las cajas y te hace retroceder si quieres pasar a través de ellas
					moto.translateX(-(forward * deltaTime));
					
				}

			}		
		}
		
	
		renderer.render(scene, camera);
	}

	function setupScene() {		
		var visibleSize = { width: window.innerWidth, height: window.innerHeight};
		clock = new THREE.Clock();		
		scene = new THREE.Scene();
		//camera = new THREE.PerspectiveCamera(100, visibleSize.width / visibleSize.height, 0.1, 120);

		var aspect = window.innerWidth / window.innerHeight;
		var d = 105;
		camera = new THREE.OrthographicCamera(  - d * aspect, d * aspect, d, - d, 1, 1000 );
		camera.position.set( 50, 60, 70 ); // all components equal
		camera.lookAt( 0, 0, 0); // or the origin
		
		//camera.rotation.y = THREE.Math.degToRad(-5);
		camera.rotation.x = THREE.Math.degToRad(-70);

		camera.rays = [
			new THREE.Vector3(1, 0, 0),
			new THREE.Vector3(-1, 0, 0),
			new THREE.Vector3(0, 0, 1),
			new THREE.Vector3(0, 0, -1),
		];

		renderer = new THREE.WebGLRenderer( {precision: "mediump" } );
		renderer.setClearColor(new THREE.Color(0, 0, 0));
		renderer.setPixelRatio(visibleSize.width / visibleSize.height);
		renderer.setSize(visibleSize.width, visibleSize.height);

		var ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
		scene.add(ambientLight);

		var directionalLight = new THREE.DirectionalLight(new THREE.Color(1, 1, 0), 0.4);
		directionalLight.position.set(0, 0, 1);
		scene.add(directionalLight);

		var grid = new THREE.GridHelper(200, 50, 0xffffff, 0xffffff);
		grid.position.y = -1;
		scene.add(grid);

		$("#scene-section").append(renderer.domElement);
	}


	</script>
</head>

<body>

	<div id="scene-section"/>

</body>
</html>